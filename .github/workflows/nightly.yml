---
name: Nightly

on:
  schedule:
    - cron: 0 0 * * *

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python: ["3.8", "3.9", "3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
      - name: Install dependencies
        run: |
          python -m pip install tox
      - name: Run tests (smoke, sanity, and regression)
        run: |
          python -m tox -e test-unit

  integration-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python: ["3.8", "3.9", "3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
      - name: Install dependencies
        run: pip install tox
      - name: Run tests (smoke and sanity)
        run: tox -e test-integration -- -m "smoke or sanity"

  e2e-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python: ["3.8", "3.9", "3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
      - name: Install dependencies
        run: pip install tox
      - name: Run tests (smoke)
        run: tox -e test-e2e -- -m smoke

  check-publish:
    runs-on: ubuntu-latest
    needs: [ unit-tests, integration-tests, e2e-tests ]
    steps:
      - uses: actions/checkout@v4
      - name: Check changes (last nightly tag)
        id: check_changes
        run: |
          git fetch origin
          LAST_NIGHTLY_TAG=$(git describe --tags --match "nightly-*" --abbrev=0)
          git diff --exit-code $LAST_NIGHTLY_TAG -- . || echo "changes"
      - name: Set env
        id: set_output
        run: |
          echo "::set-output name=changes_detected::$(git diff --exit-code $LAST_NIGHTLY_TAG -- . || echo 'true')"

  publish:
    runs-on: ubuntu-latest
    needs: [ check-publish ]
    uses: neuralmagic/nm-actions/actions/python-tox-release@main
    with:
      publish_pypi: true
      publish_nm_pypi: false
      build_type: nightly
    secrets:
      GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
      GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_NM_PYPI_SA: ${{ secrets.GCP_NM_PYPI_SA }}
      NM_PYPI_SA: ${{ secrets.NM_PYPI_SA }}
      PYPI_PUBLIC_USER: ${{ secrets.PYPI_PUBLIC_USER }}
      PYPI_PUBLIC_AUTH: ${{ secrets.PYPI_PUBLIC_AUTH }}

  tag:
    runs-on: ubuntu-latest
    needs: [ publish ]
    if: ${{ needs.check-publish.outputs.changes_detected == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Tag nightly
        run: |
          git tag nightly-$(date +'%Y%m%d')
          git push origin --tags
